<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'>
		<meta http-equiv='X-UA-Compatible' content='IE=edge'>
		<meta name='viewport' content='width=device-width, initial-scale=1'>
		<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script> 
        <title>DiaDraw</title>
        <style>
            #cv {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .canv {
                border: 1px solid black;
                /* position: absolute; */
                top: 7em;
            }

            .canv-master {
                z-index: 100;
            }

            h1 {
                text-align: center;
            }
        </style>
    </head>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var oSocket = io();
    </script>
	<body>
        <div>
            <p>
                Bem Vindo!<br/>
                Conecte-se via o IP(s): <span id="ip"></span>
                <script>
                $.get('/ips', function(res){
                    $('#ip').html(res);
                })
                </script>
            </p>
            <h1>Canvas</h1>
            <!-- <div id="cv">
                <canvas id="canvas" width="500px" height="500px" style="border: 1px solid black"></canvas>
            </div> -->
        </div>
		
        <script>
            
            const EVENTO_ADD_USER             = 'addUser';
            const CRIA_PONTO_ORIGEM           = 'ponto_origem';
            const CRIA_PONTO_DESTINO          = 'ponto_destino';
            const CRIA_PONTO_MOVIMENTO        = 'ponto_movimento'; 
            const APAGA_PONTO                 = 'apagar';
            const BROADCAST_USUARIO_CONECTADO = 'uConectado';

            const dvMain     = document.getElementById("div-main");
            const cvCanvas   = document.createElement('canvas');
            const ctx        = cvCanvas.getContext("2d");


            let usuarios  = new Map();
            let divCanvas = document.createElement('div');

            divCanvas.id = 'cv';
            
            cvCanvas.width  = 300;
            cvCanvas.height = 300;
            cvCanvas.classList.add('canv');
            cvCanvas.classList.add('canv-master');

            divCanvas.appendChild(cvCanvas);

            ctx.strokeStyle = 'black';
            ctx.lineWidth = 1;

            let corpo = document.querySelector('body div');
            corpo.appendChild(divCanvas);
            
            const iCorrecao  = cvCanvas.getBoundingClientRect(); 
            console.log(iCorrecao);


            // const oSocket = io.connect("http://localhost:3000");

            let bMovendo = false;

            // cvCanvas.id = "canvas";
            // dvMain.appendChild(cvCanvas);

            function moverPara(x, y) {
                ctx.beginPath();
                ctx.strokeStyle = "black";
                console.log('MoverPara: x: ' + x, 'y: ' + y);
                oSocket.emit(CRIA_PONTO_ORIGEM, {x: x, y: y});

                //oSocket.emit(CRIA_PONTO_DESTINO, {x: x, y: y});
                ctx.moveTo(x, y);
            }
            
            function linhaPara(x, y) {
                // ctx.beginPath();
                ctx.strokeStyle = "black";
                console.log('LinhaPara: x: ' + x, 'y: ' + y);
                ctx.lineTo(x, y);
                ctx.stroke();
                oSocket.emit(CRIA_PONTO_MOVIMENTO, {x: x, y: y});
            }
            
            function mousePressionado(e) {
                bMovendo = true;
                moverPara(e.clientX - iCorrecao.left, e.clientY - iCorrecao.top);
            }
            
            function mouseSolto() {
                bMovendo = false;
                oSocket.emit(CRIA_PONTO_DESTINO);
            }
            
            function mouseMovendo(e) {
                if(bMovendo) {
                    linhaPara(e.clientX - iCorrecao.left, e.clientY - iCorrecao.top);
                }
            }
                
            cvCanvas.addEventListener("mousedown", mousePressionado);
            cvCanvas.addEventListener("mousemove", mouseMovendo);
            window.addEventListener("mouseup"  , mouseSolto);

            oSocket.emit(EVENTO_ADD_USER, "AndrewAdm", -16776961);

            oSocket.on(BROADCAST_USUARIO_CONECTADO, function(data) {
                usuarios.set(data.username, new Usuario(data.username, "red", divCanvas));
            });

            oSocket.on(CRIA_PONTO_ORIGEM, function(data) {
                let usu = usuarios.get(data.username);
                if(typeof usu === "undefined") {
                    return;
                }
                usu.moverPara(data.ponto.x, data.ponto.y);

            });

            oSocket.on(CRIA_PONTO_MOVIMENTO, function(data) {
                let usu = usuarios.get(data.username);
                if(typeof usu === "undefined") {
                    return;
                }
                usu.linhaPara(data.ponto.x, data.ponto.y);
            });

            // oSocket.on(CRIA_PONTO_DESTINO, function(data) {
            //     let usu = usuarios.get(data.username);
            //     if(typeof usu === "undefined") {
            //         return;
            //     }
            //     usu.linhaPara();
            // });

            oSocket.on(APAGA_PONTO, function(data) {
                let usu = usuarios.get(data.username);
                if(typeof usu === "undefined") {
                    return;
                }
                usu.apagar();
            });

            function Usuario(username, cor, divCv) {

                este = this;    

                this.cv = document.createElement('canvas');
                this.cv.width  = 300;
                this.cv.height = 300;
                this.cv.classList.add('canv');

                divCv.appendChild(this.cv);

                this.username = username;
                this.cor      = cor;
                // this.pontosMoverPara = [];
                // this.pontosLinhaPara = [];
                this.ctx      = this.cv.getContext("2d");

                this.ctx.fillStyle = cor;
                this.cX = 0;
                this.cY = 0; 

                this.moverPara = function(x, y) {
                    este.ctx.beginPath();
                    este.ctx.strokeStyle = cor;
                    este.ctx.moveTo(x, y);
                    este.cX = x;
                    este.cY = y;
                    console.log("mover para: " + x + ", " + y);
                    // this.pontosMoverPara.push({x:x, y:y});
                }

                this.mover = function(x, y) {
                    este.ctx.strokeStyle = cor;
                    // este.ctx.quaTo(este.cX, este.cY, (x + este.cX)/2, ((y) + este.cY)/2);
                    este.cX = x;
                    este.cY = y;
                    console.log("mover: " + x + ", " + y);
                }

                this.linhaPara =  function(x, y) {
                    // this.ctx.beginPath();
                    este.ctx.strokeStyle = cor;
                    este.ctx.lineTo(x, y);
                    este.ctx.stroke();
                    console.log("linha para: " + x + ", " + y);
                    // this.pontosLinhaPara.push({x:x, y:y});
                }

                this.apagar = function() {
                    // for(var i =0; i < this.pontosMoverPara.length; i++) {
                    //     p = this.pontosMoverPara[i];
                    //     this.ctx.clearRect(p.x-10, p.y-10, 30, 30);
                    // }
                    // for(var i =0; i < this.pontosLinhaPara.length; i++) {
                    //     p = this.pontosLinhaPara[i];
                    //     this.ctx.clearRect(p.x-10, p.y-10, 30, 30);
                    // }
                    // this.ctx.clearRect(0, 0, cvCanvas.width, cvCanvas.height);
                }
            }

            function draw() {
                var ctx = document.getElementById('canvas').getContext('2d');
                for (var i=0;i<6;i++){
                for (var j=0;j<6;j++){
                    ctx.strokeStyle = 'rgb(0,' + Math.floor(255-42.5*i) + ',' +
                                    Math.floor(255-42.5*j) + ')';
                    ctx.beginPath();
                    ctx.arc(12.5+j*25,12.5+i*25,10,0,Math.PI*2,true);
                    ctx.stroke();
                }
                }
            }

        </script>
	</body>
</html>